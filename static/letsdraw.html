<!doctype html>
<html lang="en">
  <head>
    <title>Dat Dar Wheel</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="theme-color" content="#ffffff">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" href="img/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
    <link rel="manifest" href="img/site.webmanifest">
    <link rel="shortcut icon" href="img/favicon.ico">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,400,700">
    <link rel="stylesheet" href="/css/site.css">
  </head>
  <style>
    body {
      background-color: white;
    }
  </style>
  <body>
    <h1 style="text-align: center;">Wheel of Life</h1>
    <div style="display: flex; justify-content: space-around; align-items: center;">
      <div style="width: 400px; text-align: center; padding: 24px">
        <canvas id="theCanvas" width="300" height="300"></canvas>
        <br/>
        <br/>
        <button type="button" onclick="rot(-1)">&lt;&lt;</button>
        <button type="button" onclick="rot(1)">&gt;&gt;</button>
      </div>
      <div>
        <div style="display: inline-block; width: 18px; height: 18px; background: #8cc;"></div>
        <input type="text" style="width:120px" data-index="0" onchange="changeLabel(event)"/>
        <input type="text" style="width:20px" data-index="0" onchange="changeValue(event)"/>
        <br/>
        <div style="display: inline-block; width: 18px; height: 18px; background: #aaf;"></div>
        <input type="text" style="width:120px" data-index="1" onchange="changeLabel(event)"/>
        <input type="text" style="width:20px" data-index="1" onchange="changeValue(event)"/>
        <br/>
        <div style="display: inline-block; width: 18px; height: 18px; background: yellow"></div>
        <input type="text" style="width:120px" data-index="2" onchange="changeLabel(event)"/>
        <input type="text" style="width:20px" data-index="2" onchange="changeValue(event)"/>
        <br/>
        <div style="display: inline-block; width: 18px; height: 18px; background: #fc8;"></div>
        <input type="text" style="width:120px" data-index="3" onchange="changeLabel(event)"/>
        <input type="text" style="width:20px" data-index="3" onchange="changeValue(event)"/>
        <br/>
        <div style="display: inline-block; width: 18px; height: 18px; background: #faa;"></div>
        <input type="text" style="width:120px" data-index="4" onchange="changeLabel(event)"/>
        <input type="text" style="width:20px" data-index="4" onchange="changeValue(event)"/>
        <br/>
        <div style="display: inline-block; width: 18px; height: 18px; background: #c8c;"></div>
        <input type="text" style="width:120px" data-index="5" onchange="changeLabel(event)"/>
        <input type="text" style="width:20px" data-index="5" onchange="changeValue(event)"/>
        <br/>
        <div style="display: inline-block; width: 18px; height: 18px; background: #8f8;"></div>
        <input type="text" style="width:120px" data-index="6" onchange="changeLabel(event)"/>
        <input type="text" style="width:20px" data-index="6" onchange="changeValue(event)"/>
        <br/>
        <div style="display: inline-block; width: 18px; height: 18px; background: #cc8;"></div>
        <input type="text" style="width:120px" data-index="7" onchange="changeLabel(event)"/>
        <input type="text" style="width:20px" data-index="7" onchange="changeValue(event)"/>
      </div>
    </div>
    <p>TODOs:
      <ul>
      <li>Save / restore</li>
      <li>Select and expand a slice</li>
      <li>Text documents for each slice</li>
      <li>Number picker</li>
      <li>Invert labels that are now upside-down.</li>
  </body>
  <script>
    var defaultOptions = {
      canvasSelector: "canvas",
      fills: [
        "#8cc", "#aaf", "yellow", "#fc8", "#faa", "#c8c", "#8f8", "#cc8",
      ],
      labels: [],
      values: [],
      center: { x: 150, y: 150 },
      radius: 150,
      tabHeight: 20,
      divider: {
        width: 0,
        style: "white"
      },
      gap: {
        style: "white"
      },
      circumference: {
        width: 1,
        style: "white"
      },
      innerCircumference: {
        width: 1,
        style: "rgba(255,255,255,0.5)"
      },
      label: {
        font: "12px Arial"
      },
      baseAngle: 2*Math.PI/16
    }
    function drawIt(options) {
      const cx = options.center.x;
      const cy = options.center.y;
      const radius = options.radius;
      const innerRadius = radius - options.tabHeight;
      const baseAngle = options.baseAngle;

      var canvas = document.querySelector(options.canvasSelector)
      var context = canvas.getContext("2d")

      var x = cx;
      var y = cy;

      function segToAngle(seg) {
        return baseAngle + 2*Math.PI * seg / 8;
      }

      function move(distance, angle) {
        x += distance * Math.cos(angle);
        y += distance * Math.sin(angle);
      }

      function getValue(seg) {
        try {
          var value = options.values[seg];
          if (typeof value !== "number") return null;
          return Math.floor(Math.max(0, Math.min(10, value)))
        }
        catch (e) {
          return null;
        }
      }

      function getLabel(seg) {
        try {
          return options.labels[seg];
        }
        catch (e) {
          return null;
        }
      }

      // Color in pie slices.
      for (var seg = 0; seg < 8; ++seg) {
        context.fillStyle = options.fills[seg];
        context.beginPath()
        x = cx; y = cy;
        context.moveTo(x, y);
        move(radius, segToAngle(seg));
        context.lineTo(x, y);
        context.arc(cx, cy, radius, segToAngle(seg), segToAngle(seg + 1))
        context.closePath();
        context.fill()
      }

      // Lighten the unsatisfied portions.
      for (var seg = 0; seg < 8; ++seg) {
        var value = getValue(seg)
        if (value == 10) continue;
        context.fillStyle = value == null ? "#ddd" : options.gap.style;
        context.beginPath()
        x = cx; y = cy;
        context.moveTo(x, y);
        move(innerRadius, segToAngle(seg));
        context.lineTo(x, y);
        context.arc(cx, cy, innerRadius, segToAngle(seg), segToAngle(seg + 1))
        context.closePath();
        context.fill()
      }

      // Redarken the satisfied portions.
      for (var seg = 0; seg < 8; ++seg) {
        var value = getValue(seg)
        if (value == 10 || value == null || value == 0) continue;
        context.fillStyle = options.fills[seg];
        context.beginPath()
        x = cx; y = cy;
        context.moveTo(x, y);
        move(innerRadius * value / 10, segToAngle(seg));
        context.lineTo(x, y);
        context.arc(cx, cy, innerRadius * value / 10, segToAngle(seg), segToAngle(seg + 1))
        context.closePath();
        context.fill()
      }

      // Draw the ribs.
      context.beginPath()
      context.lineWidth = options.divider.width;
      context.strokeStyle = options.divider.style;
      for (var seg = 0; seg < 8; ++seg) {
        x = cx; y = cy;
        context.moveTo(x, y);
        move(radius, segToAngle(seg));
        context.lineTo(x, y);
      }
      context.stroke()

      // Draw the inner ring.
      context.lineWidth = options.innerCircumference.width;
      context.strokeStyle = options.innerCircumference.style;
      context.beginPath()
      context.arc(cx, cy, innerRadius, segToAngle(0), segToAngle(8))
      context.stroke()

      // Draw the outer ring.
      context.beginPath()
      context.lineWidth = options.circumference.width;
      context.strokeStyle = options.circumference.style;
      context.arc(cx, cy, radius, segToAngle(0), segToAngle(8))
      context.stroke()

      // Draw the labels.
      for (var seg = 0; seg < 8; ++seg) {
        var label = getLabel(seg);
        if (!label) continue;
        context.save()
        context.fillStyle = "black";
        context.textAlign = "center";
        context.font = options.label.font;
        x = cx; y = cy;
        move(innerRadius + 4, segToAngle(seg + 0.5));
        context.translate(x, y)
        context.rotate(segToAngle(seg + 0.5) + Math.PI/2)
        context.fillText(options.labels[seg], 0, 0)
        context.restore()
      }
    }
    var values = []
    var labels = []
    var interval = null;
    var currentAngle = defaultOptions.baseAngle;
    var targetAngle = currentAngle; 
    function draw() {
      drawIt(Object.assign({}, defaultOptions, { values: values, labels: labels, baseAngle: currentAngle }))
    }
    draw();
    function changeValue(event) {
      var index = parseInt(event.target.getAttribute("data-index"))
      while (values.length < index + 1) {
        values.push(null)
      }
      var newValue = parseInt(event.target.value)
      values[index] = newValue;
      draw();
    }
    function changeLabel(event) {
      var index = parseInt(event.target.getAttribute("data-index"))
      while (labels.length < index + 1) {
        labels.push(null)
      }
      var newValue = event.target.value;
      labels[index] = newValue;
      draw();
    }
    function rot(dir) {
      targetAngle += (2*Math.PI/8) * dir;
      if (!interval) {
        interval = setInterval(function() {
          var diff = targetAngle - currentAngle;
          if (Math.abs(diff) < 0.01) {
            clearInterval(interval);
            interval = null;
            currentAngle = targetAngle;
          }
          else {
            currentAngle += diff * 0.15;
          }
          draw();
        }, 40);
      }
    }
  </script>
</html>
